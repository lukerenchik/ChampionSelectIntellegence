<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="../static/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League of Legends Match Predictor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            display: flex;
            justify-content: space-between;
        }
        .team {
            width: 45%;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .team h2 {
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        .winner {
            text-align: center;
            margin-top: 20px;
        }
        .stats {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>

    <!-- Match Display and User Interaction -->
    <div class="container" id="match-section">
        <div class="team" id="blue-team">
            <h2>Blue Team</h2>
            <table id="blue-team-table">
                <thead>
                    <tr>
                        <th>Pick</th>
                        <th>Ban</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data for Blue Team will be inserted here -->
                </tbody>
            </table>
            <div class="winner">
                <button onclick="selectWinner('blue')">Select as Winner</button>
            </div>
        </div>

        <div class="team" id="red-team">
            <h2>Red Team</h2>
            <table id="red-team-table">
                <thead>
                    <tr>
                        <th>Pick</th>
                        <th>Ban</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data for Red Team will be inserted here -->
                </tbody>
            </table>
            <div class="winner">
                <button onclick="selectWinner('red')">Select as Winner</button>
            </div>
        </div>
    </div>

    <!-- User Stats -->
    <div class="stats" id="stats-section">
        <p>Correct Choices: <span id="correct-counter">0</span></p>
        <p>Incorrect Choices: <span id="incorrect-counter">0</span></p>
        <p>Percentage Correct: <span id="percentage-correct">0%</span></p>
    </div>

    <!-- JavaScript -->
    <script>
        let correctCounter = 0;
        let incorrectCounter = 0;

        // Fetch random match data and display in the tables
        async function fetchMatchData() {
            try {
                console.log('Fetching match data...');
                const response = await fetch('/api/rand_match');
                const data = await response.json();

                console.log('Fetched match data:', data);  // Log the fetched data

                // Call displayMatch to populate the actual HTML page
                displayMatch(data);
            } catch (error) {
                console.error('Error fetching match data:', error);
                alert('An error occurred while fetching match data.');
            }
        }

        // Display match data in table format
        function displayMatch(data) {
            const blueTeamTable = document.getElementById('blue-team-table').getElementsByTagName('tbody')[0];
            const redTeamTable = document.getElementById('red-team-table').getElementsByTagName('tbody')[0];

            console.log('Displaying match data:', data);  // Log to check if function is called

            // Clear previous entries
            blueTeamTable.innerHTML = '';
            redTeamTable.innerHTML = '';

            // Iterate through the player data and split into teams
            data.forEach(player => {
                const row = document.createElement('tr');
                const pickCell = document.createElement('td');
                const banCell = document.createElement('td');
                pickCell.textContent = player.player_champName;
                banCell.textContent = player.player_champName_ban || '-';

                if (player.player_teamId === 100) {  // Blue team
                    row.appendChild(pickCell);
                    row.appendChild(banCell);
                    blueTeamTable.appendChild(row);
                } else if (player.player_teamId === 200) {  // Red team
                    row.appendChild(pickCell);
                    row.appendChild(banCell);
                    redTeamTable.appendChild(row);
                }
            });

            // Set the actual winning team for validation later
            const winningPlayer = data.find(player => player.player_win);  // Find a player where player_win is true
            window.actualWinningTeam = winningPlayer.player_teamId === 100 ? 'blue' : 'red';
        }

        // Handle Winner Selection
        function selectWinner(selectedTeam) {
            const actualWinningTeam = window.actualWinningTeam;

            if (selectedTeam === actualWinningTeam) {
                correctCounter++;
                alert('Correct guess!');
            } else {
                incorrectCounter++;
                alert('Incorrect guess!');
            }

            updateStats();
            fetchMatchData();  // Fetch new match after each guess
        }

        // Update user stats
        function updateStats() {
            document.getElementById('correct-counter').textContent = correctCounter;
            document.getElementById('incorrect-counter').textContent = incorrectCounter;

            const total = correctCounter + incorrectCounter;
            const percentage = total > 0 ? ((correctCounter / total) * 100).toFixed(2) : 0;
            document.getElementById('percentage-correct').textContent = `${percentage}%`;
        }

        // Initialize the page by fetching the first match
        window.onload = function() {
            fetchMatchData();
        };
    </script>
</body>
</html>
